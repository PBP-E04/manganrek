<!-- Add Review Modal -->
<div id="addReviewModal" tabindex="-1" aria-hidden="true" class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-black bg-opacity-50 overflow-x-hidden overflow-y-auto backdrop-blur-sm transition-opacity duration-300 ease-out">
  <div id="addReviewModalContent" class="relative bg-white rounded-2xl shadow-2xl w-5/6 sm:w-3/4 md:w-1/2 lg:w-1/3 mx-4 sm:mx-0 transform scale-95 opacity-0 transition-transform transition-opacity duration-300 ease-out">
      <!-- Modal header -->
      <div class="flex items-center justify-between p-6 border-b">
          <h3 class="text-2xl font-bold text-[#76B947]">Add Review</h3>
          <button type="button" class="text-gray-400 hover:text-gray-600 transition-colors duration-200" id="closeAddReviewModal">
              <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
              </svg>
          </button>
      </div>

      <!-- Modal body -->
      <form id="reviewForm" class="px-6 py-4 space-y-6">
          <input type="hidden" id="productId" name="productId">
          <div>
              <label for="rating" class="block text-sm font-medium text-gray-700 mb-2">Rating</label>
              <div class="flex space-x-2" id="ratingStars">
                  <button type="button" class="star text-2xl text-gray-300 hover:text-yellow-500" data-rating="1">★</button>
                  <button type="button" class="star text-2xl text-gray-300 hover:text-yellow-500" data-rating="2">★</button>
                  <button type="button" class="star text-2xl text-gray-300 hover:text-yellow-500" data-rating="3">★</button>
                  <button type="button" class="star text-2xl text-gray-300 hover:text-yellow-500" data-rating="4">★</button>
                  <button type="button" class="star text-2xl text-gray-300 hover:text-yellow-500" data-rating="5">★</button>
              </div>
              <input type="hidden" id="ratingInput" name="rating" required>
          </div>
          <div>
              <label for="comment" class="block text-sm font-medium text-gray-700 mb-2">Comment</label>
              <textarea id="comment" name="comment" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#76B947] focus:border-transparent" required></textarea>
          </div>
      </form>

      <!-- Modal footer -->
      <div class="flex justify-end space-x-3 p-6 border-t">
          <button type="button" id="cancelAddReviewBtn" class="px-6 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors duration-200">
              Cancel
          </button>
          <button type="button" id="submitReviewBtn" class="px-6 py-2 rounded-lg bg-[#76B947] text-white hover:bg-[#5a8e35] transition-colors duration-200">
              Submit
          </button>
      </div>
  </div>
</div>

<script>
  // Add Review Modal Functions
  function showAddReviewModal(productId) {
      const modal = document.getElementById('addReviewModal');
      const modalContent = document.getElementById('addReviewModalContent');
      document.getElementById('productId').value = productId;
      
      modal.classList.remove('hidden');
      setTimeout(() => {
          modalContent.classList.add('opacity-100', 'scale-100');
          modalContent.classList.remove('scale-95', 'opacity-0');
      }, 50);
      document.body.style.overflow = 'hidden';
  }

  function hideAddReviewModal() {
      const modal = document.getElementById('addReviewModal');
      const modalContent = document.getElementById('addReviewModalContent');
      
      modalContent.classList.remove('opacity-100', 'scale-100');
      modalContent.classList.add('scale-95', 'opacity-0');
      
      setTimeout(() => {
          modal.classList.add('hidden');
          document.body.style.overflow = 'auto';
          resetReviewForm();
      }, 300);
  }

  function resetReviewForm() {
      document.getElementById('reviewForm').reset();
      document.getElementById('ratingInput').value = '';
      document.querySelectorAll('.star').forEach(star => {
          star.classList.remove('text-yellow-500');
          star.classList.add('text-gray-300');
      });
  }

  // Star Rating System
  document.querySelectorAll('.star').forEach(star => {
      star.addEventListener('click', (e) => {
          const rating = e.target.dataset.rating;
          document.getElementById('ratingInput').value = rating;
          
          document.querySelectorAll('.star').forEach(s => {
              const starRating = s.dataset.rating;
              if (starRating <= rating) {
                  s.classList.remove('text-gray-300');
                  s.classList.add('text-yellow-500');
              } else {
                  s.classList.remove('text-yellow-500');
                  s.classList.add('text-gray-300');
              }
          });
      });
  });

  // Utility function to get CSRF token
  function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }

  // Submit Review Function
  async function submitReview() {
      const form = document.getElementById('reviewForm');
      const rating = document.getElementById('ratingInput').value;
      const comment = document.getElementById('comment').value;
      const productId = document.getElementById('productId').value;

      if (!rating || !comment) {
          alert('Please provide both rating and comment');
          return;
      }

      try {
          const response = await fetch('/submit-review/', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': getCookie('csrftoken')
              },
              body: JSON.stringify({
                  product_id: productId,
                  rating: rating,
                  comment: comment
              })
          });

          if (response.ok) {
              hideAddReviewModal();
          } else {
              alert('Error submitting review');
          }
      } catch (error) {
          console.error('Error submitting review:', error);
          alert('Error submitting review');
      }
  }

  // Event Listeners
  document.getElementById('closeAddReviewModal').addEventListener('click', hideAddReviewModal);
  document.getElementById('cancelAddReviewBtn').addEventListener('click', hideAddReviewModal);
  document.getElementById('submitReviewBtn').addEventListener('click', submitReview);

  // Close modal on outside click
  document.getElementById('addReviewModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('addReviewModal')) {
          hideAddReviewModal();
      }
  });

  // Close modal with Escape key
  document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !document.getElementById('addReviewModal').classList.contains('hidden')) {
          hideAddReviewModal();
      }
  });
</script>
