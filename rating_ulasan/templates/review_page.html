{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/rating_ulasan.css' %}">

<!-- Centered Search Bar at the Top -->
<div class="flex items-center justify-center pt-5">
    <form method="get" id="restaurant-search-form">
        {% csrf_token %}
        <input id="search-input" type="text" name="q" placeholder="Search for a restaurant..." class="border-b-2 border-gray-300 bg-white h-10 pr-36 pl-4 rod-md shadow-sm text-sm ml-1 sm:pr-60">
        <button type="submit" class="px-2 text-sm sm:px-4 py-2 bg-teal-500 text-white hover:bg-teal-700 rounded-md shadow-sm border-b-2 border-gray-300">Search</button>
    </form>
</div>

<!-- Restaurant Cards -->
<div class="restaurant-cards" id="restaurants">
  {% for restaurant in restaurants %}
    {% include 'resto_card.html' with restaurant=restaurant %}
  {% endfor %}
</div>

<script>
document.getElementById('restaurant-search-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const searchQuery = document.getElementById('search-input').value;

    try {
        // Fetch search results
        const response = await fetch(`search/?q=${searchQuery}`);
        const data = await response.json();

        // Clear previous results
        const searchResults = document.getElementById('restaurants');
        searchResults.innerHTML = '';

        // Generate restaurant card HTML dynamically
        if (data && data.length > 0) {
            data.forEach(restaurant => {
                searchResults.innerHTML += `
                <div class="restaurant-card">
                    <h2>${restaurant.fields.nama}</h2>
                    <img src="${restaurant.fields.image_url}" alt="${restaurant.fields.nama}" class="restaurant-image">
                    <p class="restaurant-address">${restaurant.fields.alamat}</p>

                    <!-- Dropdown for Reviews -->
                    <div class="reviews-dropdown">
                      <button onclick="toggleReviews('${restaurant.pk}')">View Reviews</button>
                      <div id="reviews-${restaurant.pk}" class="reviews-content" style="display: none;">
                        
                        <!-- Latest Two Reviews -->
                        <!-- Render these dynamically if needed based on restaurant.reviews -->
                        <p>No reviews available yet.</p>
                        
                        <!-- User's Review Section (mocked for example) -->
                        <p>Your Review: Lorem ipsum dolor sit.</p>
                        <button onclick="editReview('${restaurant.pk}')">Edit</button>
                        <button onclick="deleteReview('${restaurant.pk}')">Delete</button>
                      </div>
                    </div>
                </div>`;
            });
        } else {
            // Display "not found" message if no results are available
            searchResults.innerHTML = `
            <div class="text-center items-center pb-20">
                <div class="flex justify-center items-center pt-12">
                    <img class="w-56" src="{% static 'images/not_found.svg' %}">
                </div>
                <h1 class="font-bold text-4xl mt-10">Restaurant not found</h1>
                <h2 class="text-gray-400 font-medium text-md mt-8">It seems that the restaurant you are looking for is not in our database</h2>
            </div>`;
        }
    } catch (error) {
        console.error('Error fetching search results:', error);
    }
});
</script>

{% endblock %}
